<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>VPS 剩余价值计算器</title>
    <meta name="description" content="基于实时汇率的VPS剩余价值计算器，支持多源汇率与透明账单。">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='0' y='0' width='64' height='64' rx='16' fill='%230f172a'/%3E%3Cpath d='M12 44 L24 32 L32 40 L52 20' stroke='%2338bdf8' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Ccircle cx='52' cy='20' r='3' fill='%2338bdf8'/%3E%3Cpath d='M52 20 L52 44' stroke='%2338bdf8' stroke-width='2' stroke-dasharray='4 4' stroke-opacity='0.5'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: -apple-system, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .dropdown-enter-active, .dropdown-leave-active { transition: all 0.2s ease; }
        .dropdown-enter-from, .dropdown-leave-to { opacity: 0; transform: translateY(-10px); }
        
        .popover-enter-active, .popover-leave-active { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .popover-enter-from, .popover-leave-to { opacity: 0; transform: translateY(10px) scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" @click="closeAllMenus">

    <div id="app" v-cloak class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-visible border border-gray-200 flex flex-col md:flex-row ring-1 ring-black/5 relative z-0">
        
        <div class="w-full md:w-5/12 p-6 bg-white flex flex-col gap-6 z-20 relative border-b md:border-b-0 md:border-r border-gray-100 rounded-t-2xl md:rounded-l-2xl md:rounded-tr-none">
            <div>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-slate-900 text-white rounded p-1 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>
                    </span>
                    配置参数
                </h1>
                <p class="text-xs text-slate-400 mt-1">基于实时汇率 · 智能结算</p>
            </div>

            <div class="space-y-3 relative z-30">
                <label class="text-xs font-bold text-gray-400 uppercase">续费原价</label>
                <div class="flex gap-2">
                    <div class="w-6/12 relative" @click.stop>
                        <button @click="toggleCurrencyDropdown" class="w-full bg-slate-50 border border-gray-200 rounded-lg py-2.5 px-2.5 flex items-center justify-between hover:border-blue-400 hover:ring-2 hover:ring-blue-100 transition-all outline-none group">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <img :src="getFlagUrl(currencyConfig[form.currency].iso)" class="w-5 h-5 rounded-full object-cover shadow-sm border border-gray-100 flex-shrink-0" alt="flag">
                                <div class="flex items-center gap-1.5 truncate text-sm">
                                    <span class="font-mono font-bold text-slate-800">{{ form.currency }}</span>
                                    <span class="text-gray-300 text-xs">•</span>
                                    <span class="text-slate-600 font-medium truncate">{{ currencyConfig[form.currency].name }}</span>
                                </div>
                            </div>
                            <svg :class="['w-3 h-3 text-gray-400 transition-transform duration-200 flex-shrink-0', isCurrencyOpen ? 'rotate-180' : '']" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <transition name="dropdown">
                            <div v-if="isCurrencyOpen" class="absolute top-full left-0 w-[140%] mt-2 bg-white rounded-xl shadow-xl border border-gray-100 max-h-64 overflow-y-auto z-50 py-1 no-scrollbar">
                                <div v-for="(cfg, key) in currencyConfig" :key="key" @click="selectCurrency(key)" :class="['flex items-center gap-3 px-4 py-3 cursor-pointer transition-colors', form.currency === key ? 'bg-blue-50' : 'hover:bg-gray-50']">
                                    <img :src="getFlagUrl(cfg.iso)" class="w-5 h-5 rounded-full object-cover shadow-sm border border-gray-100 flex-shrink-0" loading="lazy">
                                    <div class="flex flex-col">
                                        <div class="flex items-center gap-2 leading-none">
                                            <span :class="['font-mono font-bold text-sm', form.currency === key ? 'text-blue-700' : 'text-slate-800']">{{ key }}</span>
                                            <span :class="['text-xs', form.currency === key ? 'text-blue-600' : 'text-slate-500']">{{ cfg.name }}</span>
                                        </div>
                                    </div>
                                    <svg v-if="form.currency === key" class="w-3 h-3 ml-auto text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                </div>
                            </div>
                        </transition>
                    </div>
                    <div class="w-6/12 relative group">
                        <span class="absolute left-3 top-2.5 text-gray-400 font-serif group-focus-within:text-blue-500 transition-colors">{{ currentSymbol }}</span>
                        <input type="number" v-model.number="form.price" class="w-full bg-slate-50 border border-gray-200 rounded-lg py-2.5 pl-7 pr-3 font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="space-y-3 z-10">
                <label class="text-xs font-bold text-gray-400 uppercase">付款周期</label>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="c in quickCycles" @click="form.cycle = c.days" :class="['py-2 rounded-md text-xs font-bold border transition-all', form.cycle === c.days ? 'bg-slate-800 border-slate-800 text-white shadow-md' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50']">{{ c.label }}</button>
                </div>
                <div class="relative">
                    <input type="number" v-model.number="form.cycle" class="w-full bg-slate-50 border border-gray-200 rounded-lg py-2 pl-3 pr-12 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none" placeholder="自定义天数">
                    <span class="absolute right-3 top-2 text-xs font-bold text-gray-400">天</span>
                </div>
            </div>

            <div class="space-y-3 z-10">
                <label class="text-xs font-bold text-gray-400 uppercase">到期时间</label>
                <input type="date" v-model="form.dueDate" class="w-full bg-slate-50 border border-gray-200 rounded-lg py-2.5 px-3 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
            </div>

            <div class="space-y-3 z-10">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-400 uppercase">结算汇率</label>
                    <div @click="forceRefresh" class="flex items-center gap-1.5 cursor-pointer text-[10px] text-blue-500 hover:text-blue-700 bg-blue-50 px-2.5 py-1 rounded-full transition select-none group border border-blue-100 hover:border-blue-200">
                        <span :class="['w-1.5 h-1.5 rounded-full', apiStatus === 'success' ? 'bg-green-500' : (apiStatus === 'loading' ? 'bg-yellow-400 animate-pulse' : 'bg-red-500')]"></span>
                        <span class="font-medium">{{ currentSourceName }}</span>
                        <span v-if="lastUpdateTime" class="text-blue-300 font-light border-l border-blue-200 pl-1.5 ml-0.5">{{ lastUpdateTime }}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 bg-blue-50/50 p-2 rounded-lg border border-blue-100">
                    <span class="text-xs font-mono text-blue-300">1{{ form.currency }} ≈</span>
                    <input type="number" step="0.0001" v-model.number="form.rate" @input="isManualRate = true" class="w-20 bg-transparent border-b border-blue-300 text-center font-bold text-blue-800 focus:border-blue-600 outline-none">
                    <span class="text-xs font-mono text-blue-300">CNY</span>
                    <span v-if="isManualRate" class="text-[10px] text-orange-500 font-bold ml-auto bg-orange-100 px-1 rounded">手动</span>
                </div>
            </div>
            
            <div class="mt-auto pt-4 border-t border-dashed border-gray-100">
                <p class="text-[10px] text-center text-gray-300 font-mono">Open Source Project</p>
            </div>
        </div>

        <div class="w-full md:w-7/12 bg-slate-50 p-6 flex flex-col justify-between z-0">
            
            <div class="space-y-6">
                <div>
                    <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex justify-between items-center">
                        <span>费用明细</span>
                        <span :class="['text-[10px] px-2 py-0.5 rounded-full font-bold', daysLeft > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">剩余 {{ daysLeft }} 天</span>
                    </h2>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col"><span class="text-[10px] text-gray-400 uppercase font-bold">Step 1: 日均成本</span><div class="font-mono text-sm text-gray-600 mt-1">{{ currentSymbol }}{{ form.price || 0 }} ÷ {{ form.cycle || 1 }}天</div></div>
                            <div class="text-right"><span class="block text-lg font-bold text-slate-700 font-mono">{{ currentSymbol }}{{ dailyPriceStr }}</span></div>
                        </div>
                        <div class="border-t border-dashed border-gray-100"></div>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col"><span class="text-[10px] text-gray-400 uppercase font-bold">Step 2: 剩余价值 (原币)</span><div class="font-mono text-sm text-gray-600 mt-1">{{ currentSymbol }}{{ dailyPriceStr }} × {{ daysLeft }}天</div></div>
                            <div class="text-right"><span class="block text-lg font-bold text-slate-700 font-mono">{{ currentSymbol }}{{ totalOriginalStr }}</span></div>
                        </div>
                        <div class="border-t border-dashed border-gray-100"></div>
                        <div class="flex items-center justify-between bg-blue-50/50 -mx-5 -mb-5 p-5 rounded-b-xl border-t border-blue-100">
                            <div class="flex flex-col"><span class="text-[10px] text-blue-400 uppercase font-bold">Step 3: 最终折算 (CNY)</span><div class="font-mono text-xs text-blue-800/60 mt-1">{{ totalOriginalStr }} × {{ form.rate }}</div></div>
                            <div class="text-right"><span class="block text-3xl font-black text-slate-800 tracking-tight"><span class="text-lg font-serif text-gray-400 font-normal">¥</span>{{ result }}</span></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 space-y-3">
                    <div class="flex items-center justify-between px-1"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">计算逻辑 (Logic Flow)</h3><span class="text-[10px] text-gray-300 font-mono">Verified</span></div>
                    <div class="bg-white border border-gray-200 rounded-xl p-5 overflow-x-auto no-scrollbar shadow-sm">
                        <div class="flex items-center justify-between min-w-[320px] text-sm font-medium">
                            <div class="flex flex-col items-center gap-2 group">
                                <div class="flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 min-w-[4.5rem] transition-colors group-hover:border-slate-300"><span class="text-xs text-slate-700 font-bold font-mono border-b border-slate-300 w-full text-center pb-0.5 mb-0.5 leading-none">{{ form.price || 0 }}</span><span class="text-xs text-slate-500 font-mono leading-none">{{ form.cycle || 1 }}</span></div><span class="text-[10px] text-slate-400 font-sans scale-95">日均成本</span>
                            </div>
                            <span class="text-slate-300 text-lg font-light pb-4">×</span>
                            <div class="flex flex-col items-center gap-2"><div class="bg-emerald-50 border border-emerald-100 text-emerald-700 font-bold px-3 py-2.5 rounded-lg min-w-[3.5rem] text-center font-mono shadow-sm">{{ daysLeft }}</div><span class="text-[10px] text-emerald-600/70 font-sans scale-95">剩余天数</span></div>
                            <span class="text-slate-300 text-lg font-light pb-4">×</span>
                            <div class="flex flex-col items-center gap-2"><div class="bg-blue-50 border border-blue-100 text-blue-700 font-bold px-3 py-2.5 rounded-lg min-w-[3.5rem] text-center font-mono shadow-sm">{{ form.rate }}</div><span class="text-[10px] text-blue-600/70 font-sans scale-95">结算汇率</span></div>
                            <span class="text-slate-300 text-lg font-light pb-4">=</span>
                            <div class="flex flex-col items-center gap-2"><div class="bg-slate-800 text-white font-bold px-3 py-2.5 rounded-lg shadow-md min-w-[5rem] text-center tracking-tight border border-slate-900">¥{{ result }}</div><span class="text-[10px] text-slate-500 font-sans scale-95">最终价值</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4 relative z-10" @click.stop>
                <div class="relative">
                    <button @click="isShareMenuOpen = !isShareMenuOpen" class="w-full py-3 bg-white border border-gray-200 hover:border-gray-300 text-gray-600 rounded-xl font-bold text-sm shadow-sm transition active:scale-[0.98] flex justify-center items-center gap-2">
                        <span v-if="copied" class="text-green-600 flex items-center gap-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> {{ copyFeedback }}</span>
                        <span v-else class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg> 分享结果</span>
                    </button>
                    <transition name="popover">
                        <div v-if="isShareMenuOpen" class="absolute bottom-full left-0 w-full mb-2 bg-white rounded-xl shadow-xl border border-gray-200 p-1.5 flex flex-col gap-1 overflow-hidden">
                            <button @click="copyAction('url')" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 text-slate-700 text-sm font-medium transition-colors text-left">
                                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-md"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg></span>
                                <div><div class="font-bold text-slate-800">复制链接</div><div class="text-[10px] text-gray-400">分享给朋友 (URL)</div></div>
                            </button>
                            <button @click="copyAction('md')" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 text-slate-700 text-sm font-medium transition-colors text-left">
                                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-md"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></span>
                                <div><div class="font-bold text-slate-800">复制 Markdown</div><div class="text-[10px] text-gray-400">文字格式 (论坛专用)</div></div>
                            </button>
                        </div>
                    </transition>
                </div>
                <button @click="generateCard" class="py-3 bg-slate-900 hover:bg-black text-white rounded-xl font-bold text-sm shadow-lg shadow-slate-300 transition active:scale-[0.98] flex justify-center items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    生成交易图
                </button>
            </div>
        </div>

        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4" @click.self="showModal = false">
                <div class="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl animate-up">
                    <div class="p-3 border-b flex justify-between items-center bg-slate-50"><span class="font-bold text-xs text-slate-500 uppercase">Transaction Proof</span><button @click="showModal = false" class="text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button></div>
                    <div class="p-6 flex justify-center bg-slate-100"><img :src="generatedImage" class="w-full shadow-lg rounded border border-gray-200 select-none"></div>
                    <div class="p-4 text-center"><p class="text-xs text-gray-400">长按保存图片 · 数据真实性由 API 验证</p></div>
                </div>
            </div>
        </transition>
    </div>

    <footer class="fixed bottom-2 w-full text-center pointer-events-none z-0 opacity-50"><p class="text-[9px] text-slate-400 font-sans scale-90">* 汇率数据仅供参考，交易金额以双方协定为准。本工具不对因汇率波动造成的损失负责。</p></footer>

    <script>
        const { createApp } = Vue;
        const CONFIG = {
            'CNY': { name: '人民币', symbol: '¥', rate: 1.00, iso: 'cn' }, 'USD': { name: '美元', symbol: '$', rate: 7.28, iso: 'us' }, 'HKD': { name: '港元', symbol: '$', rate: 0.93, iso: 'hk' }, 'GBP': { name: '英镑', symbol: '£', rate: 9.15, iso: 'gb' }, 'EUR': { name: '欧元', symbol: '€', rate: 7.60, iso: 'eu' }, 'JPY': { name: '日元', symbol: '¥', rate: 0.047, iso: 'jp' }, 'TWD': { name: '新台币', symbol: '$', rate: 0.22, iso: 'tw' }, 'SGD': { name: '新加坡元', symbol: '$', rate: 5.35, iso: 'sg' }, 'AUD': { name: '澳大利亚元', symbol: '$', rate: 4.65, iso: 'au' }, 'CAD': { name: '加拿大元', symbol: '$', rate: 5.10, iso: 'ca' }
        };

        createApp({
            data() {
                return {
                    currencyConfig: CONFIG, apiStatus: 'idle', currentSourceName: '默认配置', lastUpdateTime: '', 
                    isManualRate: false, showModal: false, generatedImage: '', copied: false, copyFeedback: '', isCurrencyOpen: false, isShareMenuOpen: false, 
                    form: { currency: 'USD', price: '', cycle: 365, dueDate: '', rate: 7.28 },
                    quickCycles: [ { label: '月付', days: 30 }, { label: '季付', days: 90 }, { label: '半年', days: 183 }, { label: '年付', days: 365 }, { label: '两年', days: 730 }, { label: '三年', days: 1095 } ]
                }
            },
            computed: {
                currentSymbol() { return this.currencyConfig[this.form.currency].symbol },
                daysLeft() {
                    if (!this.form.dueDate) return 0;
                    const now = new Date(); const due = new Date(this.form.dueDate);
                    const utcNow = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()); const utcDue = Date.UTC(due.getFullYear(), due.getMonth(), due.getDate());
                    const diff = utcDue - utcNow; const days = Math.ceil(diff / (86400000));
                    return days > 0 ? days : 0;
                },
                dailyPriceStr() { if(!this.form.price || !this.form.cycle) return '0.0000'; return (this.form.price / this.form.cycle).toFixed(4); },
                totalOriginalStr() { if(!this.form.price || !this.form.cycle) return '0.00'; return (this.form.price / this.form.cycle * this.daysLeft).toFixed(2); },
                result() { const rawVal = parseFloat(this.totalOriginalStr) * this.form.rate; return (Math.round((rawVal + Number.EPSILON) * 100) / 100).toFixed(2); }
            },
            mounted() { this.initDefaultDate(); this.fetchRatesMultiSource(); this.loadParams(); },
            methods: {
                getFlagUrl(iso) { return `https://flagcdn.com/w40/${iso}.png`; },
                closeAllMenus() { this.isCurrencyOpen = false; this.isShareMenuOpen = false; },
                toggleCurrencyDropdown() { this.isCurrencyOpen = !this.isCurrencyOpen; this.isShareMenuOpen = false; },
                selectCurrency(key) { this.form.currency = key; this.handleCurrencyChange(); this.isCurrencyOpen = false; },
                initDefaultDate() { const t = new Date(); t.setDate(t.getDate() + 90); this.form.dueDate = t.toISOString().split('T')[0]; },
                async fetchRatesMultiSource() {
                    this.apiStatus = 'loading'; this.currentSourceName = '同步中...';
                    const sources = [
                        { name: 'ExchangeRate-API', url: 'https://open.er-api.com/v6/latest/CNY', parser: (data) => data.result === 'success' ? data.rates : null },
                        { name: 'Frankfurter', url: 'https://api.frankfurter.app/latest?from=CNY', parser: (data) => data.rates },
                        { name: 'Currency-API', url: 'https://latest.currency-api.pages.dev/v1/currencies/cny.json', parser: (data) => data.cny }
                    ];
                    let success = false;
                    for (const source of sources) {
                        try {
                            const controller = new AbortController(); setTimeout(() => controller.abort(), 3000);
                            const res = await fetch(source.url, { signal: controller.signal }); if (!res.ok) throw new Error('Status ' + res.status);
                            const json = await res.json(); const rates = source.parser(json);
                            if (rates) { this.updateRates(rates, source.name); success = true; break; }
                        } catch (e) { continue; }
                    }
                    if (!success) { this.apiStatus = 'error'; this.currentSourceName = '连接失败'; this.isManualRate = true; }
                },
                updateRates(rates, sourceName) {
                    const now = new Date();
                    // 记录最后更新时间 (格式: 14:30:05)
                    this.lastUpdateTime = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                    
                    for (let key in this.currencyConfig) {
                        let rateVal = rates[key] || rates[key.toLowerCase()];
                        if (key === 'CNY') { this.currencyConfig[key].rate = 1.00; continue; }
                        if (rateVal) { this.currencyConfig[key].rate = parseFloat((1 / rateVal).toFixed(4)); }
                    }
                    if (!this.isManualRate) this.handleCurrencyChange(); this.apiStatus = 'success'; this.currentSourceName = sourceName;
                },
                forceRefresh() { this.isManualRate = false; this.fetchRatesMultiSource(); },
                handleCurrencyChange() { this.form.rate = this.currencyConfig[this.form.currency].rate; },
                
                // 还原为纯文字版 Markdown
                copyAction(type) {
                    const params = new URLSearchParams({ c: this.form.currency, p: this.form.price, cy: this.form.cycle, d: this.form.dueDate, r: this.form.rate });
                    const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                    history.replaceState(null, '', '?' + params.toString());

                    let textToCopy = url;
                    if (type === 'md') {
                        // 纯文字 Markdown 格式
                        textToCopy = `[VPS剩余价值: ¥${this.result} (剩余${this.daysLeft}天)](${url})`;
                    }

                    navigator.clipboard.writeText(textToCopy).then(() => {
                        this.copyFeedback = type === 'md' ? 'Markdown 已复制' : '链接已复制';
                        this.copied = true;
                        this.isShareMenuOpen = false;
                        setTimeout(() => { this.copied = false; }, 2000);
                    });
                },

                loadParams() {
                    const p = new URLSearchParams(location.search);
                    if(p.has('c')) this.form.currency = p.get('c');
                    if(p.has('p')) this.form.price = p.get('p');
                    if(p.has('cy')) this.form.cycle = parseInt(p.get('cy'));
                    if(p.has('d')) this.form.dueDate = p.get('d');
                    if(p.has('r')) { this.form.rate = parseFloat(p.get('r')); this.isManualRate = true; }
                },
                generateCard() {
                    const nowStr = new Date().toLocaleString('zh-CN', { hour12: false });
                    const sourceLabel = this.isManualRate ? 'Manual Rate' : `API: ${this.currentSourceName}`;
                    const svgContent = `
                    <svg width="600" height="380" xmlns="http://www.w3.org/2000/svg">
                        <defs><linearGradient id="bg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" /><stop offset="100%" style="stop-color:#e2e8f0;stop-opacity:1" /></linearGradient></defs>
                        <rect width="100%" height="100%" fill="white"/>
                        <rect x="20" y="20" width="560" height="340" rx="12" fill="url(#bg)" stroke="#94a3b8" stroke-width="1"/>
                        <rect x="20" y="20" width="560" height="80" rx="12" fill="#1e293b"/>
                        <rect x="20" y="80" width="560" height="20" fill="#1e293b"/>
                        <text x="50" y="65" font-family="sans-serif" font-size="22" fill="white" font-weight="bold">VPS 交易结算单</text>
                        <text x="550" y="65" font-family="sans-serif" font-size="12" fill="#94a3b8" text-anchor="end">${nowStr}</text>
                        <text x="300" y="160" font-family="sans-serif" font-size="14" fill="#64748b" text-anchor="middle">剩余价值 (CNY)</text>
                        <text x="300" y="220" font-family="sans-serif" font-size="60" fill="#0f172a" font-weight="bold" text-anchor="middle">¥ ${this.result}</text>
                        <line x1="50" y1="250" x2="550" y2="250" stroke="#cbd5e1" stroke-width="1" stroke-dasharray="4"/>
                        <text x="80" y="290" font-family="sans-serif" font-size="12" fill="#64748b">原价 / 周期</text>
                        <text x="80" y="315" font-family="sans-serif" font-size="16" fill="#334155" font-weight="bold">${this.currentSymbol}${this.form.price} / ${this.form.cycle}天</text>
                        <text x="300" y="290" font-family="sans-serif" font-size="12" fill="#64748b" text-anchor="middle">结算汇率</text>
                        <text x="300" y="315" font-family="sans-serif" font-size="16" fill="#334155" font-weight="bold" text-anchor="middle">1:${this.form.rate}</text>
                        <text x="520" y="290" font-family="sans-serif" font-size="12" fill="#64748b" text-anchor="end">剩余天数</text>
                        <text x="520" y="315" font-family="sans-serif" font-size="16" fill="#16a34a" font-weight="bold" text-anchor="end">${this.daysLeft} 天</text>
                        <text x="300" y="350" font-family="monospace" font-size="10" fill="#94a3b8" text-anchor="middle">Source: ${sourceLabel}</text>
                    </svg>`;
                    const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    const reader = new FileReader();
                    reader.onload = (e) => { this.generatedImage = e.target.result; this.showModal = true; };
                    reader.readAsDataURL(blob);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>